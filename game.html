<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoes of the Past</title>
    <style>
        body {
            font-family: 'Georgia', serif;
            background-color: #111;
            color: #f0f0f0;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            padding-left: 120px; /* Increase padding to prevent overlap with wider map panel */
            position: relative;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        h1 {
            font-size: 36px;
            color: #ddd;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-style: italic;
            color: #aaa;
            margin-bottom: 30px;
        }
        
        .story-section {
            background-color: rgba(30, 30, 30, 0.8);
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .choice-button {
            display: block;
            width: 100%;
            background-color: rgba(50, 50, 70, 0.8);
            color: #fff;
            border: none;
            padding: 12px 15px;
            margin: 10px 0;
            font-size: 16px;
            text-align: left;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .choice-button:hover {
            background-color: rgba(70, 70, 100, 0.9);
            transform: translateY(-2px);
        }
        
        .player-choice {
            background-color: rgba(80, 80, 100, 0.6);
            border-left: 4px solid #4caf50;
            padding: 10px 15px;
            margin: 15px 0;
            font-style: italic;
        }
        
        .restart-button {
            display: block;
            margin: 20px auto;
            background-color: rgba(60, 60, 90, 0.8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .error-message {
            background-color: rgba(255, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .loading-indicator {
            text-align: center;
            margin: 20px 0;
        }
        
        .error-recovery {
            background-color: rgba(100, 100, 100, 0.3);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .location-indicator {
            font-size: 0.9em;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        
        strong {
            color: #4caf50;
        }
        
        /* Menu Button */
        .menu-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(50, 50, 70, 0.8);
            color: #fff;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .menu-toggle:hover {
            background-color: rgba(70, 70, 100, 0.9);
        }
        
        /* Echo Collection Panel */
        .echo-collection {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 250px;
            background-color: rgba(20, 20, 30, 0.95);
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            padding: 15px;
            z-index: 99;
            max-height: 40vh;
            overflow-y: auto;
            transition: transform 0.4s ease, opacity 0.3s ease;
            transform: translateX(-120%);
            opacity: 0;
        }
        
        .echo-collection.shown {
            transform: translateX(0);
            opacity: 1;
        }
        
        .echo-collection h3 {
            text-align: center;
            margin-top: 0;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .echo-item {
            margin-bottom: 20px;
            background-color: rgba(40, 40, 60, 0.6);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .echo-item h4 {
            margin-top: 0;
            color: #4caf50;
            border-bottom: 1px solid rgba(76, 175, 80, 0.3);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        
        .echo-item p {
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.4;
            color: #ddd;
        }
        
        .echo-placeholder {
            text-align: center;
            border: 2px dashed #333;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .echo-image {
            max-width: 100%;
            max-height: 150px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: block;
        }
        
        .empty-collection {
            text-align: center;
            font-style: italic;
            color: #777;
            padding: 30px 0;
        }
        
        /* Map Panel */
        .map-panel {
            position: fixed;
            top: 70px;
            left: 20px;
            width: 350px;
            background-color: rgba(20, 20, 30, 0.95);
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            padding: 15px;
            z-index: 99;
            max-height: 60vh;
            overflow-y: auto;
            transition: transform 0.4s ease, opacity 0.3s ease;
            transform: translateX(-120%);
            opacity: 0;
        }
        
        .map-panel.shown {
            transform: translateX(0);
            opacity: 1;
        }
        
        .map-panel h3 {
            text-align: center;
            margin-top: 0;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .map-container {
            position: relative;
            height: 300px;
            border: 1px solid #333;
            margin: 15px 0;
            background-color: rgba(40, 40, 50, 0.7);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .map-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            font-style: italic;
        }
        
        .map-location {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #4caf50;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .map-location:hover {
            width: 20px;
            height: 20px;
            background-color: #6abf6e;
        }
        
        .map-location.current {
            background-color: #ff9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.7);
        }
        
        .map-legend {
            margin-top: 15px;
            font-size: 14px;
            color: #ddd;
        }
        
        .map-legend div {
            margin-bottom: 5px;
        }
        
        .map-legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .map-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        /* Menu Panel */
        .menu-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 250px;
            background-color: rgba(20, 20, 30, 0.95);
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            padding: 15px;
            z-index: 99;
            transition: transform 0.4s ease, opacity 0.3s ease;
            transform: translateX(120%);
            opacity: 0;
        }
        
        .menu-panel.shown {
            transform: translateX(0);
            opacity: 1;
        }
        
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        .menu-panel h3 {
            margin: 0;
            color: #8257e5;
            font-size: 18px;
        }
        
        .close-button {
            background: none;
            border: none;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
            padding: 0 5px;
            transition: all 0.2s ease;
        }
        
        .close-button:hover {
            color: #fff;
        }
        
        .menu-button {
            display: block;
            width: 100%;
            background-color: rgba(50, 50, 70, 0.8);
            color: #fff;
            border: none;
            padding: 12px 15px;
            margin: 10px 0;
            font-size: 16px;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-sizing: border-box;
            text-decoration: none;
        }
        
        .menu-button:hover {
            background-color: rgba(70, 70, 100, 0.9);
        }
        
        /* Location Images */
        .location-image-container {
            text-align: center;
            margin: 20px 0;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .location-image {
            max-width: 100%;
            max-height: 250px;
            display: block;
            margin: 0 auto;
        }
        
        .location-image-placeholder {
            width: 100%;
            height: 200px;
            background-color: rgba(40, 40, 50, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-style: italic;
        }
        
        /* Fragment image in the story */
        .fragment-image-container {
            text-align: center;
            margin: 20px 0;
        }
        
        /* Animation helpers */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fadeIn {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* Custom Modal Dialog Styles */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .custom-modal.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: rgba(20, 20, 30, 0.95);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 20px;
            width: 350px;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .custom-modal.visible .modal-content {
            transform: translateY(0);
        }
        
        .modal-message {
            margin-bottom: 20px;
            font-size: 16px;
            color: #f0f0f0;
            white-space: pre-line; /* Preserve line breaks */
            text-align: left;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .modal-button {
            background-color: rgba(50, 50, 70, 0.8);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        .modal-button.confirm {
            background-color: rgba(76, 175, 80, 0.5);
        }
        
        .modal-button.confirm:hover {
            background-color: rgba(76, 175, 80, 0.7);
        }
        
        .modal-button.cancel {
            background-color: rgba(244, 67, 54, 0.5);
        }
        
        .modal-button.cancel:hover {
            background-color: rgba(244, 67, 54, 0.7);
        }
        
        @keyframes glow {
            from {
                text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #5865F2, 0 0 20px #5865F2;
            }
            to {
                text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #8257E5, 0 0 40px #8257E5;
            }
        }
        
        .choice-number {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-color: rgba(70, 70, 120, 0.7);
            color: #fff;
            text-align: center;
            line-height: 24px;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .choice-button:hover .choice-number {
            background-color: rgba(100, 100, 180, 0.9);
        }
        
        /* Add the new floating side buttons CSS */
        .quick-buttons {
            position: static;
            z-index: 95;
        }
        
        .quick-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(50, 50, 70, 0.8);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 95;
            position: fixed;
        }
        
        .quick-button:hover {
            background-color: rgba(70, 70, 100, 0.9);
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .quick-button.map-btn {
            background-color: rgba(76, 175, 80, 0.5);
            position: fixed;
            top: 20px;
            left: 20px;
        }
        
        .quick-button.map-btn:hover {
            background-color: rgba(76, 175, 80, 0.7);
        }
        
        .quick-button.echo-btn {
            background-color: rgba(88, 101, 242, 0.5);
            position: fixed;
            bottom: 20px;
            left: 20px;
        }
        
        .quick-button.echo-btn:hover {
            background-color: rgba(88, 101, 242, 0.7);
        }
        
        .quick-button-tooltip {
            position: absolute;
            background-color: rgba(30, 30, 40, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            white-space: nowrap;
        }
        
        .map-btn .quick-button-tooltip {
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .echo-btn .quick-button-tooltip {
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .quick-button:hover .quick-button-tooltip {
            opacity: 1;
        }
        
        /* Ensure the quick buttons don't block content on small screens */
        @media (max-width: 768px) {
            .quick-buttons {
                top: auto;
                bottom: 20px;
                left: 20px;
                flex-direction: row;
            }
        }
        
        /* Quick buttons positioning to match the panels */
        .quick-buttons {
            position: static;
            z-index: 95;
        }
        
        @media (max-width: 768px) {
            .quick-buttons {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .quick-button.map-btn {
                top: 80px;
            }
            
            .quick-button.echo-btn {
                bottom: 80px;
            }
            
            .container {
                padding-left: 70px; /* Add some padding to prevent content from being hidden behind buttons */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ECHOES OF THE PAST</h1>
            <p class="subtitle">A journey through memory and time</p>
        </header>
        
        <div id="story-container">
            <!-- Story content will be dynamically inserted here -->
            <div class="story-section">
                <div class="location-indicator">RUINS ENTRANCE</div>
                <p>You open your eyes, though you're not sure if they were ever closed.</p>
                <p>The ground beneath you is cracked stone. Cold. Damp.</p>
                <p>Above, a bloated moon clings to a colorless sky. Somewhere in the distance, something breathes—not with lungs, but with <strong>time</strong>.</p>
                <p>You exhale. Or at least, you think you do.</p>
                
                <div class="game-info" style="background-color: rgba(80, 80, 120, 0.3); padding: 15px; margin: 15px 0; border-radius: 5px; font-style: italic; border-left: 3px solid #5865f2;">
                    <p><strong>Game Help:</strong> During your journey, you can collect memory echoes and discover new locations.</p>
                    <p>- Use the <strong>Menu</strong> button in the top right to access the game menu</p>
                    <p>- The <strong>View Echoes</strong> button shows your collected memory fragments</p>
                    <p>- The <strong>View Map</strong> button displays locations you've discovered</p>
                    <p>- Press number keys <strong>1-3</strong> to quickly select choices</p>
                </div>
                
                <button class="choice-button" onclick="makeChoice('look_around')"><span class="choice-number">1</span>Look around</button>
                <button class="choice-button" onclick="makeChoice('walk_forward')"><span class="choice-number">2</span>Walk forward</button>
            </div>
        </div>
    </div>
    
    <!-- Echo Collection Panel -->
    <div id="echo-collection" class="echo-collection">
        <h3>Echo Collection</h3>
        <button id="close-echoes" class="close-button" style="position: absolute; top: 10px; right: 10px; font-size: 20px; cursor: pointer; color: #aaa; background: none; border: none;">&times;</button>
        <div id="echo-list">
            <div class="empty-collection">No echoes collected yet...</div>
        </div>
    </div>
    
    <!-- Map Panel -->
    <div id="map-panel" class="map-panel">
        <h3>Discovered Locations</h3>
        <button id="close-map" class="close-button" style="position: absolute; top: 10px; right: 10px; font-size: 20px; cursor: pointer; color: #aaa; background: none; border: none;">&times;</button>
        <div class="map-container">
            <div class="map-placeholder">Map will appear as you discover locations...</div>
            <!-- Map markers will be added here dynamically -->
        </div>
        <div class="map-legend">
            <div class="map-legend-item">
                <div class="map-legend-color" style="background-color: #4caf50;"></div>
                <span>Discovered Location</span>
            </div>
            <div class="map-legend-item">
                <div class="map-legend-color" style="background-color: #ff9800;"></div>
                <span>Current Location</span>
            </div>
        </div>
    </div>
    
    <!-- Menu Button and Panel -->
    <button id="menu-toggle" class="menu-toggle">Menu</button>
    <div id="menu-panel" class="menu-panel">
        <div class="menu-header">
            <h3>Game Menu</h3>
            <button id="close-menu" class="close-button">&times;</button>
        </div>
        <button id="instructions-button" class="menu-button">Instructions</button>
        <button id="restart-button" class="menu-button">Restart Game</button>
        <a href="menu.html" class="menu-button" style="display: inline-block; width: 100%;">Main Menu</a>
    </div>
    
    <!-- Quick Access Buttons -->
    <div class="quick-buttons">
        <button class="quick-button map-btn" id="quick-map-toggle">
            <span>🗺️</span>
            <span class="quick-button-tooltip">View Map</span>
        </button>
        <button class="quick-button echo-btn" id="quick-echo-toggle">
            <span>💫</span>
            <span class="quick-button-tooltip">View Echoes</span>
        </button>
    </div>
    
    <!-- Custom Modal Dialog -->
    <div id="custom-modal" class="custom-modal">
        <div class="modal-content">
            <div id="modal-message" class="modal-message">Modal message goes here</div>
            <div class="modal-buttons">
                <button id="modal-confirm" class="modal-button confirm">OK</button>
                <button id="modal-cancel" class="modal-button cancel">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // Simple story management system with error recovery
        const storyContent = {
            look_around: {
                location: "CITY RUINS",
                text: [
                    "The city is crumbling, but there is a strange stillness.",
                    "Blackened structures claw toward the sky, half-swallowed by fog.",
                    "The only light comes from your chest — a soft, pulsing glow.",
                    "It flickers, in rhythm with something beneath the world.",
                    "You remember... nothing."
                ],
                choices: [
                    { id: "keep_exploring", text: "Continue exploring" }
                ]
            },
            walk_forward: {
                location: "CITY RUINS",
                text: [
                    "The stones shift beneath your feet.",
                    "Each step echoes longer than it should.",
                    "In the distance, you hear a hum — not mechanical, but alive.",
                    "Something waits to be seen."
                ],
                choices: [
                    { id: "first_choice", text: "Move toward the sound" }
                ]
            },
            keep_exploring: {
                location: "CITY RUINS - CROSSROADS",
                text: [
                    "The road narrows. The air tightens.",
                    "You walk toward a broken arch, half-submerged in soil and time.",
                    "To your left, a path descends into shadow.",
                    "To your right, something flickers behind a rusted gate."
                ],
                choices: [
                    { id: "whisper_caverns", text: "Take the left path" },
                    { id: "memory_gate", text: "Approach the gate" },
                    { id: "arch_echo", text: "Examine the arch" }
                ]
            },
            first_choice: {
                location: "CITY RUINS - SHRINE",
                text: [
                    "You pass the remnants of what may have been a shrine.",
                    "Shattered beams. Crushed stone.",
                    "Something catches your eye — a glimmer beneath the rubble.",
                    "It pulses like your own chest does. But slower. Older."
                ],
                choices: [
                    { id: "investigate_glimmer", text: "Investigate the glimmer" },
                    { id: "leave_alone", text: "Leave it alone" }
                ]
            },
            investigate_glimmer: {
                location: "CITY RUINS - SHRINE",
                text: [
                    "You brush aside the debris and reveal a glowing shard.",
                    "It pulses gently in your hand.",
                    "It is warm. Familiar.",
                    "You don't remember what it is—but it remembers you.",
                    "The glowing shard fades after a moment, but something has changed in you.",
                    "The emblem on your chest pulses slightly stronger now."
                ],
                isEcho: true,
                echoId: "shrine_shard",
                echoName: "Shrine Shard",
                echoDescription: "A fragment of crystallized memory, pulsing with the heartbeat of a forgotten ritual.",
                choices: [
                    { id: "keep_exploring", text: "Continue" }
                ]
            },
            leave_alone: {
                location: "CITY RUINS - SHRINE",
                text: [
                    "You step away.",
                    "Some things are better left buried.",
                    "The light dims behind you."
                ],
                choices: [
                    { id: "keep_exploring", text: "Continue" }
                ]
            },
            whisper_caverns: {
                location: "WHISPER CAVERNS - ENTRANCE",
                text: [
                    "You descend slowly, your light barely touching the walls.",
                    "The echo follows.",
                    "You find yourself in a cavern not carved by hands, but by forgetting.",
                    "The walls breathe. Somewhere, water drips.",
                    "It sounds almost like a voice."
                ],
                choices: [
                    { id: "follow_sound", text: "Follow the sound" },
                    { id: "touch_walls", text: "Touch the walls" }
                ]
            },
            memory_gate: {
                location: "MEMORY GATE",
                text: [
                    "The gate resists you at first.",
                    "But the moment you place your hand on it, the hum returns—louder.",
                    "This gate remembers.",
                    "There is no key, only recognition.",
                    "A glyph glows on its frame—the same one on your chest."
                ],
                choices: [
                    { id: "press_emblem_gate", text: "Press your emblem against the gate" },
                    { id: "try_another_path", text: "Try another path" }
                ]
            },
            press_emblem_gate: {
                location: "MEMORY GATE",
                text: [
                    "The gate shudders and begins to open, revealing a garden beyond.",
                    "But something isn't right. The plants flicker in and out of existence, unstable memories of what once grew here."
                ],
                choices: [
                    { id: "ghost_garden_entry", text: "Enter the garden" }
                ]
            },
            try_another_path: {
                location: "CITY RUINS",
                text: [
                    "You decide to explore elsewhere first."
                ],
                choices: [
                    { id: "keep_exploring", text: "Return to the crossroads" }
                ]
            },
            arch_echo: {
                location: "CITY RUINS - ARCH",
                text: [
                    "You approach the broken arch. Ancient symbols are carved into its weathered surface.",
                    "As you trace them with your finger, you feel a resonance with the emblem on your chest.",
                    "The arch begins to glow faintly, responding to your touch."
                ],
                choices: [
                    { id: "press_emblem_arch", text: "Press the emblem on your chest against the arch" },
                    { id: "step_back", text: "Step back" }
                ]
            },
            press_emblem_arch: {
                location: "CITY RUINS - ARCH",
                text: [
                    "A sudden flash of light. Images pour into your mind:",
                    "A bustling city square. Towering spires. People with glowing symbols on their chests.",
                    "Then darkness falls. Screams. A great machine beneath the city pulses erratically.",
                    "You stumble back, overwhelmed by the vision.",
                    "The arch stands silent again, its secret shared."
                ],
                isEcho: true,
                echoId: "arch_vision",
                echoName: "Arch Vision",
                echoDescription: "A fragment revealing the city's final moments, preserved in the ancient stone of the arch.",
                choices: [
                    { id: "keep_exploring", text: "Continue exploring" }
                ]
            },
            step_back: {
                location: "CITY RUINS - ARCH",
                text: [
                    "You withdraw your hand. The glow fades.",
                    "Some memories might be too painful to restore."
                ],
                choices: [
                    { id: "keep_exploring", text: "Return to the junction" }
                ]
            },
            follow_sound: {
                location: "WHISPER CAVERNS - DEEPER PASSAGE",
                text: [
                    "You follow the dripping sound deeper into the cavern.",
                    "The walls begin to whisper as you pass. Not in words, but in memory.",
                    "You come to a vast underground lake, its surface perfectly still.",
                    "In the center, something rises from the water."
                ],
                choices: [
                    { id: "underwater_chamber", text: "Wade into the water" },
                    { id: "back_to_cavern", text: "Return to the entrance" }
                ]
            },
            touch_walls: {
                location: "WHISPER CAVERNS",
                text: [
                    "You place your hand against the damp stone.",
                    "The cavern shudders. Not physically, but in time.",
                    "Echoes of conversations, footsteps, prayers resonate through your fingers.",
                    "These walls remember what walked within them."
                ],
                isEcho: true,
                echoId: "cavern_whispers",
                echoName: "Cavern Whispers",
                echoDescription: "The stone remembers those who passed through these halls, their words etched in the dampness.",
                choices: [
                    { id: "follow_sound", text: "Follow the dripping sound" },
                    { id: "back_to_cavern", text: "Return to the entrance" }
                ]
            },
            back_to_cavern: {
                location: "WHISPER CAVERNS - ENTRANCE",
                text: [
                    "You make your way back to the cavern entrance."
                ],
                choices: [
                    { id: "keep_exploring", text: "Return to the surface" }
                ]
            },
            underwater_chamber: {
                location: "WHISPER CAVERNS - UNDERWATER CHAMBER",
                text: [
                    "The pool's surface reflects your face—or what would be your face if your hood wasn't obscuring it.",
                    "Something glints beneath the water. A mask, perhaps, with no features."
                ],
                choices: [
                    { id: "reach_mask", text: "Reach for the mask" },
                    { id: "leave_mask", text: "Leave it be" }
                ]
            },
            reach_mask: {
                location: "WHISPER CAVERNS - UNDERWATER CHAMBER",
                text: [
                    "You reach into the cold water and retrieve the mask.",
                    "It's featureless, smooth as glass, but you sense it's important.",
                    "The mask seems to hum in your hands, resonating with the emblem on your chest.",
                    "You feel it belongs with you, though you can't explain why."
                ],
                isEcho: true,
                echoId: "faceless_mask",
                echoName: "Faceless Mask",
                echoDescription: "A smooth, featureless mask. It seems to wait for an identity to imprint upon it.",
                choices: [
                    { id: "return_to_surface", text: "Return to the surface" }
                ]
            },
            leave_mask: {
                location: "WHISPER CAVERNS - UNDERWATER CHAMBER",
                text: [
                    "You draw back. Some artifacts are not meant to be disturbed.",
                    "The reflection ripples and settles again."
                ],
                choices: [
                    { id: "back_to_cavern", text: "Return to the cavern entrance" }
                ]
            },
            return_to_surface: {
                location: "CITY RUINS",
                text: [
                    "You make your way back through the cavern and up to the surface."
                ],
                choices: [
                    { id: "demo_ending", text: "Continue" }
                ]
            },
            ghost_garden_entry: {
                location: "GHOST GARDEN",
                text: [
                    "You step into the garden. Plants phase in and out of existence around you.",
                    "In the center stands a tall, still figure. It doesn't move, but you sense it's watching you."
                ],
                choices: [
                    { id: "approach_figure", text: "Approach the figure" },
                    { id: "explore_garden", text: "Explore the garden" }
                ]
            },
            approach_figure: {
                location: "GHOST GARDEN - CENTRAL AREA",
                text: [
                    "As you approach, the figure remains motionless.",
                    "It wears a cloak similar to yours, but its face is obscured by a featureless mask.",
                    "This must be the Silent Watcher mentioned in the echoes."
                ],
                choices: [
                    { id: "demo_ending", text: "Continue" }
                ]
            },
            explore_garden: {
                location: "GHOST GARDEN - PERIPHERY",
                text: [
                    "You decide to explore the unstable garden first.",
                    "Plants bloom and wither as you pass, their lifecycle compressed into moments.",
                    "You find an echo trapped in the heart of a flower that exists only in memory.",
                    "The echo pulses in rhythm with your emblem.",
                    "You've collected another fragment of this world's past."
                ],
                isEcho: true,
                echoId: "garden_flower",
                echoName: "Memory Flower",
                echoDescription: "A temporal anomaly in the form of a flower, blooming and withering in moments, preserving a fragment of the garden's beauty.",
                choices: [
                    { id: "approach_figure", text: "Approach the Silent Watcher now" }
                ]
            },
            demo_ending: {
                location: "JOURNEY CONTINUATION",
                text: [
                    "As you proceed deeper into this world, the journey continues..."
                ],
                choices: [
                    { id: "silent_watcher_meeting", text: "Continue your journey" }
                ]
            },
            silent_watcher_meeting: {
                location: "GHOST GARDEN - THE WATCHER",
                text: [
                    "The Silent Watcher remains motionless as you approach.",
                    "Though its face is hidden behind a featureless mask, you feel its gaze upon you.",
                    "The emblem on your chest pulses more strongly, resonating with something in the Watcher's presence."
                ],
                choices: [
                    { id: "watcher_purpose", text: "Ask about your purpose" },
                    { id: "watcher_echoes", text: "Show the echoes you've collected" },
                    { id: "watcher_silence", text: "Remain silent" }
                ]
            },
            watcher_purpose: {
                location: "GHOST GARDEN - THE WATCHER",
                text: [
                    "You try to speak, but find no words. Instead, your question forms as a thought, projected toward the Watcher.",
                    "*Why am I here?*",
                    "Though the Watcher doesn't move, you feel a response forming in your mind.",
                    "*To remember. To choose.*"
                ],
                choices: [
                    { id: "watcher_guidance", text: "Listen for more" }
                ]
            },
            watcher_echoes: {
                location: "GHOST GARDEN - THE WATCHER",
                text: [
                    "You focus on the echoes you've gathered, willing them to manifest.",
                    "Small orbs of light materialize around you, each containing a fragment of memory you've recovered.",
                    "The Watcher regards them, then raises a hand. The echoes orbit faster, forming patterns."
                ],
                choices: [
                    { id: "watcher_guidance", text: "Listen for guidance" }
                ]
            },
            watcher_silence: {
                location: "GHOST GARDEN - THE WATCHER",
                text: [
                    "You stand in silence, watching the Watcher watch you.",
                    "After what feels like an eternity, the Watcher inclines its head slightly.",
                    "You sense approval in the gesture. Sometimes, silence is the correct response."
                ],
                choices: [
                    { id: "watcher_guidance", text: "Wait for guidance" }
                ]
            },
            watcher_guidance: {
                location: "GHOST GARDEN - THE WATCHER",
                text: [
                    "The Watcher's voice continues in your mind:",
                    "*Beneath the city lies the Memory Core. The heart of what was. The seed of what could be.*",
                    "*The echoes you've gathered are fragments of a greater whole. Take them to the Core.*",
                    "*There, you will understand. There, you will choose.*"
                ],
                choices: [
                    { id: "watcher_find_core", text: "Ask how to find the Memory Core" },
                    { id: "watcher_choice", text: "Ask what choice awaits" },
                    { id: "watcher_nod", text: "Nod and depart" }
                ]
            },
            watcher_find_core: {
                location: "GHOST GARDEN - THE WATCHER",
                text: [
                    "*The path opens to those who carry enough echoes. Return to the gate.*",
                    "*The mask you found will guide you deeper.*"
                ],
                choices: [
                    { id: "watcher_departure", text: "Acknowledge" }
                ]
            },
            watcher_choice: {
                location: "GHOST GARDEN - THE WATCHER",
                text: [
                    "*Your choice will determine the fate of what you've remembered.*",
                    "*Restore. Preserve. Release. Transform. Become.*",
                    "*Each path has consequences. Each reshapes what remains.*"
                ],
                choices: [
                    { id: "watcher_departure", text: "Consider this" }
                ]
            },
            watcher_nod: {
                location: "GHOST GARDEN - THE WATCHER",
                text: [
                    "You acknowledge the Watcher's guidance with a simple nod.",
                    "The Watcher mirrors your gesture, a silent understanding passing between you."
                ],
                choices: [
                    { id: "watcher_departure", text: "Prepare to leave" }
                ]
            },
            watcher_departure: {
                location: "GHOST GARDEN - THE WATCHER",
                text: [
                    "As you turn to leave, the Watcher speaks one final thought into your mind:",
                    "*We have stood at this threshold before, you and I. In different forms. Making different choices.*",
                    "*The cycle continues, but it need not repeat exactly.*",
                    "With those cryptic words echoing in your thoughts, you make your way back toward the Memory Gate."
                ],
                choices: [
                    { id: "memory_gate_return", text: "Return to the Memory Gate" }
                ]
            },
            memory_gate_return: {
                location: "MEMORY GATE",
                text: [
                    "The Memory Gate stands before you, its ancient mechanisms humming with recognition.",
                    "The mask in your possession seems to resonate with the gate, pulling you toward it."
                ],
                choices: [
                    { id: "activate_gate", text: "Place the mask against the gate" }
                ]
            },
            activate_gate: {
                location: "MEMORY GATE",
                text: [
                    "The moment the mask touches the gate, both begin to glow intensely.",
                    "The gate shudders, then splits open to reveal not the garden you saw before, but a spiraling staircase descending deep beneath the city.",
                    "A soft blue light emanates from below, pulsing in rhythm with your emblem."
                ],
                choices: [
                    { id: "descend_to_core", text: "Descend the staircase" }
                ]
            },
            descend_to_core: {
                location: "SPIRAL STAIRCASE",
                text: [
                    "You descend the spiral staircase, each step bringing you deeper into the earth.",
                    "The walls around you are etched with circuitry that pulses with light as you pass.",
                    "The echoes you've collected throughout your journey grow more agitated, resonating with something below."
                ],
                choices: [
                    { id: "memory_core_arrival", text: "Continue descending" }
                ]
            },
            memory_core_arrival: {
                location: "MEMORY CORE",
                text: [
                    "You emerge into a vast circular chamber dominated by a column of pure light that stretches from floor to ceiling.",
                    "The light pulses and shifts, almost alive. This must be the Memory Core—the heart of the city's memory system.",
                    "The emblem on your chest burns brighter than ever, and the echoes you've collected orbit around you like tiny stars."
                ],
                choices: [
                    { id: "approach_column", text: "Approach the column" },
                    { id: "circle_perimeter", text: "Circle the perimeter" }
                ]
            },
            approach_column: {
                location: "MEMORY CORE - CENTRAL COLUMN",
                text: [
                    "You step forward, the light washing over you.",
                    "The emblem on your chest burns brighter than ever, almost painful. It's calling to something in the column—or perhaps the column is calling to it."
                ],
                choices: [
                    { id: "core_recognition", text: "Reach toward the light" }
                ]
            },
            circle_perimeter: {
                location: "MEMORY CORE - PERIMETER",
                text: [
                    "You walk the edge of the chamber, studying the column from different angles.",
                    "The walls are etched with circuitry that pulses in rhythm with the light. Equations and symbols flow across the surface, mathematical poetry describing the architecture of memory itself.",
                    "On the far side, you find a small terminal with a single interface: a mask-shaped depression."
                ],
                choices: [
                    { id: "mask_terminal", text: "Place the mask in the depression" }
                ]
            },
            core_recognition: {
                location: "MEMORY CORE - RESONANCE",
                text: [
                    "The light engulfs you completely. For a moment, you feel weightless.",
                    "Then the voices begin—fragments of conversations, laughter, screams, whispers—all the sounds of a city that once lived, compressed into a cacophony that threatens to overwhelm you."
                ],
                choices: [
                    { id: "focus_echoes", text: "Focus on the echoes you've collected" }
                ]
            },
            focus_echoes: {
                location: "MEMORY CORE - REVELATION",
                text: [
                    "The echoes you've gathered form a pattern within you. They give structure to the chaos, shielding you from being lost in the flood of memories.",
                    "The light recedes slightly, and you see a figure standing on the other side of the column. Tall, still, watching—the same entity you encountered in the garden.",
                    "But now you understand. This is no mere observer. This is the Guardian of Memory, the one who came before you."
                ],
                choices: [
                    { id: "final_choice", text: "Listen to the Guardian" }
                ]
            },
            mask_terminal: {
                location: "MEMORY CORE - TERMINAL",
                text: [
                    "You hold the mask over the depression. It hovers for a moment, suspended by an unseen force, then settles into place.",
                    "The walls flicker. Suddenly, ghostly scenes play across them—moments from the city's past. People walking streets that are now ruins. Buildings standing tall where there are now only fragments.",
                    "A voice echoes through the chamber: \"Configuration accepted. Access granted to Pattern Archive. Please specify memory reconstruction parameters.\""
                ],
                choices: [
                    { id: "restoration_ending", text: "Full restoration" },
                    { id: "curator_ending", text: "Selective restoration" },
                    { id: "transcendence_ending", text: "Reject restoration" }
                ]
            },
            final_choice: {
                location: "MEMORY CORE - DECISION",
                text: [
                    "The column pulses, awaiting your decision. The echoes you've gathered hover around you like stars in a private constellation. What will you do with what you've remembered?"
                ],
                choices: [
                    { id: "watcher_ending", text: "Become the new Watcher" },
                    { id: "release_ending", text: "Release the echoes" },
                    { id: "rebirth_ending", text: "Create something new" }
                ]
            },
            restoration_ending: {
                location: "RESTORATION ENDING",
                text: [
                    "The Memory Core erupts with light that floods through the entire underground chamber and beyond. You feel reality shuddering around you as time folds back upon itself.",
                    "When your vision clears, you stand in the middle of a street. Not a ruin, but a living thoroughfare. People pass by, speaking in languages you somehow understand. The buildings stand tall, their architecture both familiar and alien.",
                    "The city breathes again. Restored to the moment before its fall.",
                    "But as you turn to take it all in, you notice something unsettling: every few seconds, the world flickers. Like a projection that can't quite hold steady. The restoration is incomplete, unstable.",
                    "The mask is gone from your hands, and the emblem on your chest has faded. Your role is finished. You have given the city a second chance—however fragile, however temporary.",
                    "As you walk down the renewed street, a tall figure watches you from the shadows of a doorway. It nods once before vanishing.",
                    "The cycle continues, but differently this time."
                ],
                ending: true,
                endingType: "restoration",
                choices: [
                    { id: "restart", text: "Start Again" }
                ]
            },
            curator_ending: {
                location: "CURATOR ENDING",
                text: [
                    "The Memory Core accepts your selection. The echoes you've chosen flow into the circuitry of the walls, illuminating patterns that spread throughout the chamber like constellations.",
                    "Not a full restoration—a curation. A memory garden of only what deserved to survive.",
                    "The mask rises from the terminal and hovers before you. It has changed, now marked with symbols that match the patterns on the walls. As you take it, you understand its purpose: not to hide your face, but to help you see what others cannot.",
                    "With the mask, you can walk between moments, visiting the echoes you've preserved. You've become the Curator of Echoes, keeper of a selective history.",
                    "As you leave the chamber, mask in hand, you sense the presence of the Watcher behind you. Not following, but acknowledging. Your paths diverge here—they to watch, you to curate.",
                    "The city remains in ruins, but within those ruins, perfect fragments of what once was continue to echo for those who know how to listen."
                ],
                ending: true,
                endingType: "curator",
                choices: [
                    { id: "restart", text: "Start Again" }
                ]
            },
            transcendence_ending: {
                location: "TRANSCENDENCE ENDING",
                text: [
                    "The Memory Core shimmers as you reject its purpose. The light changes quality, becoming not restoration but transformation.",
                    "You don't want to recreate the past. You don't want to preserve it. You want to transcend it.",
                    "The mask trembles in your hand, then dissolves into particles of light that swirl around you. The emblem on your chest responds in kind, expanding outward until it envelops your entire form.",
                    "You feel yourself changing. Not becoming something else, but becoming *more* of what you already were.",
                    "When the light subsides, you remain in the chamber, but you know you're different now. You can see the echoes without activating them. You can walk through time without disturbing it.",
                    "You have become something beyond memory or forgetting—a conscious bridge between what was and what is.",
                    "As you ascend the spiral staircase one last time, you meet the Watcher. For the first time, you see beyond their stillness to what they truly are: not an entity, but a possibility. A path you chose not to take.",
                    "The city awaits you—not to be rebuilt, but to be understood in a way no one else can comprehend."
                ],
                ending: true,
                endingType: "transcendence",
                choices: [
                    { id: "restart", text: "Start Again" }
                ]
            },
            watcher_ending: {
                location: "WATCHER ENDING",
                text: [
                    "The column's light wraps around you like a cloak. You feel yourself changing—not physically, but fundamentally. Your perspective shifts. Your awareness expands.",
                    "Time becomes visible to you—not as a line, but as a tapestry. The city exists in all its states simultaneously: being built, standing proud, crumbling, forgotten, rediscovered.",
                    "And you see the others. The Veiled Wanderers who came before you. The ones who will come after. Some became Watchers like you are becoming. Others chose different paths.",
                    "The cycle is endless, but not unchanging. Each Wanderer who reaches this point alters the pattern slightly.",
                    "As the transformation completes, you take your place. Not merely observing, but maintaining. The echoes will continue. The city will remain in its state of remembering and forgetting.",
                    "And when the next Wanderer arrives, drawn by the emblem that once adorned your chest, you will watch. You will guide. You will wait."
                ],
                ending: true,
                endingType: "watcher",
                choices: [
                    { id: "restart", text: "Start Again" }
                ]
            },
            release_ending: {
                location: "RELEASE ENDING",
                text: [
                    "The echoes hesitate, as if uncertain. Then, one by one, they drift away from you, passing through the walls of the chamber, returning to the places where you found them.",
                    "But they don't simply return—they *expand*. Each memory fragment grows, spreading through the ruins, momentarily restoring not just its immediate area but creating a chain reaction.",
                    "Through the walls of the chamber, you see the city light up as the echoes reach their destinations. For one breathtaking moment, everything is illuminated—the complete pattern visible for the first time.",
                    "Then it fades, not into darkness, but into peace. The compulsion to remember, to preserve, to echo—it dissipates.",
                    "The column of light dims, but doesn't go out entirely. Something new begins to form at its center: not memory, but possibility.",
                    "You leave the Memory Core changed. The emblem on your chest no longer glows, but feels warm against your skin. Your journey through echoes has ended, but something else has begun.",
                    "As you emerge from the underground, the ruins look different—not restored, but unburdened. Ready for what comes next."
                ],
                ending: true,
                endingType: "release",
                choices: [
                    { id: "restart", text: "Start Again" }
                ]
            },
            rebirth_ending: {
                location: "REBIRTH ENDING",
                text: [
                    "The echoes around you begin to move. Not drifting away, not returning to the column, but dancing. Merging. Transforming.",
                    "The patterns they form are unlike anything you saw in the ruins. These aren't memories anymore—they're possibilities. Not echoes of what was, but whispers of what could be.",
                    "The column pulses in response, its light changing from the stark white of memory to a spectrum of colors that have no names. The walls of the chamber transform, circuitry flowering into organic patterns.",
                    "You understand: this place was never meant to simply preserve the past. It was waiting for someone to see beyond restoration to reinvention.",
                    "As the transformation spreads beyond the chamber, you feel the entire underground complex awakening to a new purpose. Not a city reborn, but something else. Something that has never existed before.",
                    "The emblem on your chest shifts and changes, matching the new patterns all around you. The old cycle is broken. The new one has just begun.",
                    "And when you finally emerge into the world above, where the ruins once stood, you find neither restoration nor continued decay, but growth of an entirely different kind."
                ],
                ending: true,
                endingType: "rebirth",
                choices: [
                    { id: "restart", text: "Start Again" }
                ]
            }
        };
        
        // Track visited scenes to prevent loops
        let visitedScenes = new Set();
        let playerChoices = [];
        
        // Echo data with descriptions and image placeholders
        const echoData = {
            shrine_shard: {
                name: "Shrine Shard",
                description: "A fragment of crystallized memory, pulsing with the heartbeat of a forgotten ritual.",
                location: "City Ruins - Shrine",
                image: "images/echoes/shrine_shard.png"
            },
            arch_vision: {
                name: "Arch Vision",
                description: "A fragment revealing the city's final moments, preserved in the ancient stone of the arch.",
                location: "City Ruins - Arch",
                image: "images/echoes/arch_vision.png"
            },
            cavern_whispers: {
                name: "Cavern Whispers",
                description: "The stone remembers those who passed through these halls, their words etched in the dampness.",
                location: "Whisper Caverns",
                image: "images/echoes/cavern_whispers.png"
            },
            faceless_mask: {
                name: "Faceless Mask",
                description: "A smooth, featureless mask. It seems to wait for an identity to imprint upon it.",
                location: "Underwater Chamber",
                image: "images/echoes/faceless_mask.png"
            },
            garden_flower: {
                name: "Memory Flower",
                description: "A temporal anomaly in the form of a flower, blooming and withering in moments, preserving a fragment of the garden's beauty.",
                location: "Ghost Garden",
                image: "images/echoes/garden_flower.png"
            },
            watcher_insight: {
                name: "Watcher's Insight",
                description: "A fragment of understanding gleaned from the Silent Watcher's presence, revealing hints of previous cycles.",
                location: "Ghost Garden - The Watcher",
                image: "images/echoes/watcher_insight.png"
            },
            staircase_etchings: {
                name: "Staircase Etchings",
                description: "Ancient mathematical formulas carved into the steps, explaining the principles behind memory preservation.",
                location: "Spiral Staircase",
                image: "images/echoes/staircase_etchings.png"
            },
            core_resonance: {
                name: "Core Resonance",
                description: "A pure fragment of the Memory Core's energy, containing echoes of countless lives and moments.",
                location: "Memory Core",
                image: "images/echoes/core_resonance.png"
            },
            terminal_blueprint: {
                name: "Terminal Blueprint",
                description: "Technical schematics for the Memory Core's systems, showing how memory was converted to energy and back.",
                location: "Memory Core - Terminal",
                image: "images/echoes/terminal_blueprint.png"
            }
        };
        
        // Location data for map and images
        const locationData = {
            city_ruins: {
                name: "City Ruins",
                description: "The crumbling remnants of a once-great civilization.",
                mapPosition: { x: 50, y: 30 },
                image: "images/locations/city_ruins.png"
            },
            shrine: {
                name: "Forgotten Shrine",
                description: "A sacred place, now shattered and abandoned.",
                mapPosition: { x: 70, y: 40 },
                image: "images/locations/shrine.png"
            },
            arch: {
                name: "Memory Arch",
                description: "Ancient stone that remembers the final days.",
                mapPosition: { x: 40, y: 45 },
                image: "images/locations/arch.png"
            },
            whisper_caverns: {
                name: "Whisper Caverns",
                description: "Tunnels where echoes of the past still linger.",
                mapPosition: { x: 25, y: 60 },
                image: "images/locations/whisper_caverns.png"
            },
            underwater_chamber: {
                name: "Underwater Chamber",
                description: "A sacred pool hiding ancient artifacts.",
                mapPosition: { x: 20, y: 80 },
                image: "images/locations/underwater_chamber.png"
            },
            memory_gate: {
                name: "Memory Gate",
                description: "A barrier that responds only to those it recognizes.",
                mapPosition: { x: 75, y: 55 },
                image: "images/locations/memory_gate.png"
            },
            ghost_garden: {
                name: "Ghost Garden",
                description: "Plants that flicker between existence and memory.",
                mapPosition: { x: 85, y: 70 },
                image: "images/locations/ghost_garden.png"
            },
            spiral_staircase: {
                name: "Spiral Staircase",
                description: "Ancient steps leading deep beneath the city to the Memory Core.",
                mapPosition: { x: 75, y: 75 },
                image: "images/locations/spiral_staircase.png"
            },
            memory_core: {
                name: "Memory Core",
                description: "The central nexus of all memories, where past and future converge.",
                mapPosition: { x: 60, y: 90 },
                image: "images/locations/memory_core.png"
            }
        };
        
        // Keep track of echo fragments found
        let echoesFound = [];
        let collectionVisible = false;
        let mapVisible = false;
        let menuVisible = false;
        let discoveredLocations = ["city_ruins"]; // Start with first location discovered
        let currentLocation = "city_ruins";
        
        // Set up echo collection toggle
        const echoCollection = document.getElementById('echo-collection');
        const echoList = document.getElementById('echo-list');
        const mapPanel = document.getElementById('map-panel');
        const mapContainer = document.querySelector('.map-container');
        const menuToggle = document.getElementById('menu-toggle');
        const menuPanel = document.getElementById('menu-panel');
        const restartButton = document.getElementById('restart-button');
        const instructionsButton = document.getElementById('instructions-button');
        const closeMenu = document.getElementById('close-menu');
        
        // Modal dialog elements
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        
        menuToggle.addEventListener('click', toggleMenu);
        closeMenu.addEventListener('click', toggleMenu);
        restartButton.addEventListener('click', confirmRestart);
        instructionsButton.addEventListener('click', showInstructions);
        
        // Add event listeners for the quick access buttons
        const quickMapToggle = document.getElementById('quick-map-toggle');
        const quickEchoToggle = document.getElementById('quick-echo-toggle');
        const closeMap = document.getElementById('close-map');
        const closeEchoes = document.getElementById('close-echoes');
        
        quickMapToggle.addEventListener('click', toggleMap);
        quickEchoToggle.addEventListener('click', toggleEchoCollection);
        closeMap.addEventListener('click', toggleMap);
        closeEchoes.addEventListener('click', toggleEchoCollection);
        
        function showModal(message, onConfirm, onCancel = null) {
            modalMessage.textContent = message;
            
            // Set up confirm button
            const confirmHandler = () => {
                modalConfirm.removeEventListener('click', confirmHandler);
                hideModal();
                if (onConfirm) onConfirm();
            };
            modalConfirm.addEventListener('click', confirmHandler);
            
            // Set up cancel button
            const cancelHandler = () => {
                modalCancel.removeEventListener('click', cancelHandler);
                hideModal();
                if (onCancel) onCancel();
            };
            modalCancel.addEventListener('click', cancelHandler);
            
            // Show the modal
            customModal.classList.add('visible');
            
            // Make cancel button visible (it's hidden for alerts)
            if (onCancel === null) {
                modalCancel.style.display = 'none';
            } else {
                modalCancel.style.display = 'block';
            }
        }
        
        function hideModal() {
            customModal.classList.remove('visible');
        }
        
        function confirmRestart() {
            showModal(
                "Are you sure you want to restart the game? Your progress will be lost.",
                () => location.reload(), // On confirm
                () => {} // On cancel
            );
        }
        
        function showInstructions() {
            showModal(
                "ECHOES OF THE PAST - SIMPLIFIED VERSION\n\n" +
                "- You are a Memory Seeker exploring a forgotten world\n" +
                "- Make choices to navigate through the story\n" +
                "- Collect memory echoes to reveal the history of this place\n" +
                "- Explore different locations on the map\n\n" +
                "SPECIAL FEATURES:\n" +
                "- Menu button (top right): Access game options\n" +
                "- View Echoes: See your collection of memory fragments\n" +
                "- View Map: See locations you've discovered\n\n" +
                "When you find a memory echo, it will automatically be added to your collection.\n" +
                "Your current location is marked in orange on the map.",
                () => {} // Just close on confirm
            );
        }
        
        function toggleEchoCollection() {
            collectionVisible = !collectionVisible;
            
            if (collectionVisible) {
                echoCollection.classList.add('shown');
                
                // Close other panels
                mapPanel.classList.remove('shown');
                mapVisible = false;
                menuPanel.classList.remove('shown');
                menuVisible = false;
            } else {
                echoCollection.classList.remove('shown');
            }
        }
        
        function toggleMap() {
            mapVisible = !mapVisible;
            
            if (mapVisible) {
                mapPanel.classList.add('shown');
                
                // Close other panels
                echoCollection.classList.remove('shown');
                collectionVisible = false;
                menuPanel.classList.remove('shown');
                menuVisible = false;
                
                // Update the map
                updateMap();
            } else {
                mapPanel.classList.remove('shown');
            }
        }
        
        function toggleMenu() {
            menuVisible = !menuVisible;
            
            if (menuVisible) {
                menuPanel.classList.add('shown');
                
                // Don't automatically close other panels when opening the menu
                // since we might want to use the menu to open them
            } else {
                menuPanel.classList.remove('shown');
            }
        }
        
        function updateEchoCollection() {
            // Clear existing content
            echoList.innerHTML = '';
            
            // Show empty message if no echoes found
            if (echoesFound.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'empty-collection';
                emptyMessage.textContent = 'No echoes collected yet...';
                echoList.appendChild(emptyMessage);
                return;
            }
            
            // Create echo items for each found echo
            echoesFound.forEach(echoId => {
                // Get the echo data from the echoData object directly for more reliable info
                let echoInfo = echoData[echoId];
                
                if (!echoInfo) {
                    // Fallback to searching in storyContent if not found in echoData
                    for (const sceneId in storyContent) {
                        const scene = storyContent[sceneId];
                        if (scene.isEcho && scene.echoId === echoId) {
                            echoInfo = {
                                id: scene.echoId,
                                name: scene.echoName,
                                description: scene.echoDescription,
                                location: scene.location || 'Unknown Location'
                            };
                            break;
                        }
                    }
                }
                
                if (!echoInfo) return; // Skip if echo info not found
                
                // Create echo element
                const echoElement = document.createElement('div');
                echoElement.className = 'echo-item';
                
                // Add echo title
                const title = document.createElement('h4');
                title.textContent = echoInfo.name;
                echoElement.appendChild(title);
                
                // Add echo image 
                if (echoInfo.image) {
                    const img = document.createElement('img');
                    img.src = echoInfo.image;
                    img.alt = echoInfo.name;
                    img.className = 'echo-image';
                    echoElement.appendChild(img);
                } else {
                    // Fallback to placeholder
                    const imagePlaceholder = document.createElement('div');
                    imagePlaceholder.className = 'echo-placeholder';
                    imagePlaceholder.textContent = 'Echo Image';
                    echoElement.appendChild(imagePlaceholder);
                }
                
                // Add description
                const description = document.createElement('p');
                description.textContent = echoInfo.description;
                echoElement.appendChild(description);
                
                // Add location info if available
                if (echoInfo.location) {
                    const locationInfo = document.createElement('p');
                    locationInfo.style.fontStyle = 'italic';
                    locationInfo.style.fontSize = '12px';
                    locationInfo.style.marginTop = '10px';
                    locationInfo.style.opacity = '0.7';
                    locationInfo.textContent = `Found at: ${echoInfo.location}`;
                    echoElement.appendChild(locationInfo);
                }
                
                echoList.appendChild(echoElement);
            });
            
            // Show the echo collection if we have echoes and it's currently visible
            if (echoesFound.length > 0 && collectionVisible) {
                echoCollection.classList.add('shown');
            }
        }
        
        function makeChoice(choiceId) {
            // Add loading indicator
            const storyContainer = document.getElementById('story-container');
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'loading-indicator';
            loadingIndicator.textContent = 'Loading...';
            storyContainer.appendChild(loadingIndicator);
            
            // Disable all previous choice buttons to prevent going back
            const allButtons = document.querySelectorAll('.choice-button');
            allButtons.forEach(button => {
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
                button.onclick = null; // Remove click handler
            });
            
            // Small delay to show loading and prevent browser freezing
            setTimeout(() => {
                // Remove loading indicator
                storyContainer.removeChild(loadingIndicator);
                
                // Prevent looping by checking if we're returning to a key location
                // If returning to first_choice when we've already been there, redirect to keep_exploring
                if (choiceId === 'first_choice' && visitedScenes.has('first_choice') && playerChoices.length > 1) {
                    choiceId = 'keep_exploring';
                }
                
                // Record this choice
                playerChoices.push(choiceId);
                visitedScenes.add(choiceId);
                
                // Get scene from story content
                let scene = storyContent[choiceId];
                
                // Special handling for "keep_exploring" which was broken
                if (choiceId === "keep_exploring" && !scene) {
                    // Instead of going to first_choice which creates a loop, go to a different location
                    if (visitedScenes.has('whisper_caverns')) {
                        choiceId = "whisper_caverns";
                    } else if (visitedScenes.has('memory_gate')) {
                        choiceId = "memory_gate"; 
                    } else {
                        choiceId = "arch_echo";
                    }
                    scene = storyContent[choiceId];
                }
                
                // Handle missing scene with error recovery
                if (!scene) {
                    console.error('Scene not found:', choiceId);
                    const errorSection = document.createElement('div');
                    errorSection.className = 'error-message';
                    errorSection.innerHTML = `<p>Error: Couldn't find the next part of the story (ID: ${choiceId})</p>`;
                    
                    const errorRecovery = document.createElement('div');
                    errorRecovery.className = 'error-recovery';
                    errorRecovery.innerHTML = `
                        <p>Let's continue your journey another way:</p>
                        <button class="choice-button" onclick="makeChoice('demo_ending')">Skip to the end</button>
                        <button class="choice-button" onclick="location.reload()">Restart the story</button>
                    `;
                    
                    storyContainer.appendChild(errorSection);
                    storyContainer.appendChild(errorRecovery);
                    
                    // Scroll to the bottom
                    window.scrollTo(0, document.body.scrollHeight);
                    return;
                }
                
                // Create player choice record for the selected button
                const choiceButtons = document.querySelectorAll('.choice-button');
                let selectedChoice = '';
                
                for (const button of choiceButtons) {
                    if (button.onclick && button.onclick.toString().includes(choiceId)) {
                        selectedChoice = button.textContent;
                        break;
                    }
                }
                
                if (selectedChoice) {
                    const playerChoiceElement = document.createElement('div');
                    playerChoiceElement.className = 'player-choice';
                    playerChoiceElement.textContent = selectedChoice;
                    storyContainer.appendChild(playerChoiceElement);
                }
                
                // Create new story section
                const storySection = document.createElement('div');
                storySection.className = 'story-section';
                
                // Add location indicator if available
                if (scene.location) {
                    const locationElement = document.createElement('div');
                    locationElement.className = 'location-indicator';
                    locationElement.textContent = scene.location;
                    storySection.appendChild(locationElement);
                    
                    // Update current location for map
                    updateLocationForMap(scene.location);
                }
                
                // Add key location image if applicable
                if (shouldShowLocationImage(choiceId)) {
                    const locationKey = getLocationKeyForScene(choiceId);
                    if (locationKey && locationData[locationKey]) {
                        const location = locationData[locationKey];
                        
                        // Create image container
                        const imageContainer = document.createElement('div');
                        imageContainer.className = 'location-image-container';
                        
                        // Create actual image element with the PNG file
                        if (location.image) {
                            const img = document.createElement('img');
                            img.src = location.image;
                            img.alt = location.name;
                            img.className = 'location-image';
                            imageContainer.appendChild(img);
                        } else {
                            // Fallback to placeholder
                            const imagePlaceholder = document.createElement('div');
                            imagePlaceholder.className = 'location-image-placeholder';
                            imagePlaceholder.textContent = `${location.name}`;
                            imageContainer.appendChild(imagePlaceholder);
                        }
                        
                        // Add to story section
                        storySection.appendChild(imageContainer);
                    }
                }
                
                // Add text paragraphs
                scene.text.forEach(paragraph => {
                    const p = document.createElement('p');
                    p.innerHTML = paragraph; // Use innerHTML to support basic HTML like <strong>
                    storySection.appendChild(p);
                });
                
                // Check if this scene has an echo to collect
                if (scene.isEcho && scene.echoId) {
                    if (!echoesFound.includes(scene.echoId)) {
                        // Add echo to collection
                        echoesFound.push(scene.echoId);
                        
                        // Add echo image placeholder
                        const imageContainer = document.createElement('div');
                        imageContainer.className = 'fragment-image-container';
                        
                        // Create actual image element if available
                        if (echoData[scene.echoId] && echoData[scene.echoId].image) {
                            const img = document.createElement('img');
                            img.src = echoData[scene.echoId].image;
                            img.alt = scene.echoName;
                            img.className = 'fragment-image';
                            imageContainer.appendChild(img);
                        } else {
                            // Fallback to placeholder
                            const imagePlaceholder = document.createElement('div');
                            imagePlaceholder.className = 'echo-placeholder';
                            imagePlaceholder.textContent = 'Echo Fragment Image';
                            imageContainer.appendChild(imagePlaceholder);
                        }
                        
                        // Add image container to the story section
                        storySection.appendChild(imageContainer);
                        
                        // Add collection notification
                        const echoNotice = document.createElement('p');
                        echoNotice.innerHTML = `<strong>Echo fragment collected: ${scene.echoName} (${echoesFound.length}/5)</strong>`;
                        storySection.appendChild(echoNotice);
                        
                        // Update the echo collection panel
                        updateEchoCollection();
                        
                        // Briefly show the echo collection
                        if (!collectionVisible) {
                            toggleEchoCollection();
                            // Auto-hide after 5 seconds
                            setTimeout(() => {
                                if (collectionVisible) {
                                    toggleEchoCollection();
                                }
                            }, 5000);
                        }
                    }
                }
                
                // Add choices
                scene.choices.forEach((choice, index) => {
                    const button = document.createElement('button');
                    button.className = 'choice-button';
                    
                    // Improved number indicator with better styling for first 3 choices
                    if (index < 3) {
                        const numberSpan = document.createElement('span');
                        numberSpan.className = 'choice-number';
                        numberSpan.textContent = index + 1;
                        button.appendChild(numberSpan);
                        button.appendChild(document.createTextNode(choice.text));
                    } else {
                        button.textContent = choice.text;
                    }
                    
                    if (choice.id === 'restart') {
                        button.addEventListener('click', confirmRestart);
                    } else {
                        button.addEventListener('click', () => {
                            makeChoice(choice.id);
                        });
                    }
                    
                    storySection.appendChild(button);
                });
                
                // If we're at demo ending, show echo count
                if (choiceId === 'demo_ending') {
                    const echoSummary = document.createElement('p');
                    echoSummary.style.marginTop = '20px';
                    echoSummary.style.fontStyle = 'italic';
                    echoSummary.textContent = `You found ${echoesFound.length} out of 5 possible echo fragments.`;
                    storySection.appendChild(echoSummary);
                }
                
                // Append new section
                storyContainer.appendChild(storySection);
                
                // Update map
                updateMap();
                
                // Scroll to the bottom
                window.scrollTo(0, document.body.scrollHeight);
            }, 200); // Small delay for visual feedback
        }
        
        function updateLocationForMap(locationText) {
            // Map location text to location keys
            const locationMapping = {
                'RUINS ENTRANCE': 'city_ruins',
                'CITY RUINS': 'city_ruins',
                'CITY RUINS - CROSSROADS': 'city_ruins',
                'CITY RUINS - SHRINE': 'shrine',
                'CITY RUINS - ARCH': 'arch',
                'WHISPER CAVERNS': 'whisper_caverns',
                'WHISPER CAVERNS - ENTRANCE': 'whisper_caverns',
                'WHISPER CAVERNS - DEEPER PASSAGE': 'whisper_caverns',
                'WHISPER CAVERNS - UNDERWATER CHAMBER': 'underwater_chamber',
                'MEMORY GATE': 'memory_gate',
                'GHOST GARDEN': 'ghost_garden',
                'GHOST GARDEN - CENTRAL AREA': 'ghost_garden',
                'GHOST GARDEN - PERIPHERY': 'ghost_garden',
                'SPIRAL STAIRCASE': 'spiral_staircase',
                'MEMORY CORE': 'memory_core',
                'JOURNEY CONTINUATION': 'city_ruins'
            };
            
            const locationKey = locationMapping[locationText];
            if (locationKey) {
                currentLocation = locationKey;
                
                // Add to discovered locations if not already there
                if (!discoveredLocations.includes(locationKey)) {
                    discoveredLocations.push(locationKey);
                    
                    // Briefly flash the map to show new location
                    if (!mapVisible) {
                        toggleMap();
                        // Auto-hide after 4 seconds
                        setTimeout(() => {
                            if (mapVisible) {
                                toggleMap();
                            }
                        }, 4000);
                    } else {
                        // If already visible, just update it
                        updateMap();
                    }
                } else {
                    // Still update the map if location changed but was already discovered
                    updateMap();
                }
            }
        }
        
        function getLocationKeyForScene(sceneId) {
            // Map certain key scenes to locations that should show images
            const keyLocationMapping = {
                'memory_gate': 'memory_gate',
                'press_emblem_gate': 'memory_gate', 
                'underwater_chamber': 'underwater_chamber',
                'reach_mask': 'underwater_chamber',
                'ghost_garden_entry': 'ghost_garden',
                'approach_figure': 'ghost_garden'
            };
            
            return keyLocationMapping[sceneId] || null;
        }
        
        function shouldShowLocationImage(sceneId) {
            // Only show location images at certain key moments
            return getLocationKeyForScene(sceneId) !== null;
        }
        
        function updateMap() {
            // Clear existing map markers
            const existingMarkers = mapContainer.querySelectorAll('.map-location');
            existingMarkers.forEach(marker => marker.remove());
            
            // Remove placeholder if we have discovered locations
            if (discoveredLocations.length > 0) {
                const placeholder = mapContainer.querySelector('.map-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
            }
            
            // Add markers for discovered locations
            discoveredLocations.forEach(locationKey => {
                const location = locationData[locationKey];
                if (location && location.mapPosition) {
                    const marker = document.createElement('div');
                    marker.className = 'map-location fadeIn';
                    if (locationKey === currentLocation) {
                        marker.classList.add('current');
                    }
                    
                    marker.style.left = `${location.mapPosition.x}%`;
                    marker.style.top = `${location.mapPosition.y}%`;
                    
                    // Add tooltip with location name
                    marker.title = location.name;
                    
                    mapContainer.appendChild(marker);
                }
            });
            
            // Show the map if it's currently visible
            if (mapVisible) {
                mapPanel.classList.add('shown');
            }
        }
        
        // Initialize map on load
        updateMap();
        
        // Hide all panels initially (making sure they're in the 'out' position)
        echoCollection.classList.remove('shown');
        mapPanel.classList.remove('shown');
        menuPanel.classList.remove('shown');
        
        // Add keyboard number support for choices (1, 2, 3)
        document.addEventListener('keydown', function(event) {
            // Only process number keys 1-3
            if (event.key >= '1' && event.key <= '3') {
                const choiceIndex = parseInt(event.key) - 1; // Convert to 0-based index
                
                // Get all visible choice buttons
                const visibleButtons = document.querySelectorAll('.story-section:last-child .choice-button');
                
                // If we have a button at the selected index, click it
                if (visibleButtons.length > choiceIndex) {
                    visibleButtons[choiceIndex].click();
                }
            }
        });
    </script>
</body>
</html> 